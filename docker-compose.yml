services:
  telegram-bot-api:
    build:
      context: .
      dockerfile: Dockerfile.telegram-bot-api
    container_name: telegram-bot-api
    restart: unless-stopped
    ports:
      - "${BOTAPI_HTTP_PORT:-8081}:8081"
    volumes:
      - ${BOTAPI_DATA_DIR:-./botapi_data}:/var/lib/telegram-bot-api
      # Share downloads so Bot API server can access file:// paths in --local mode
      - ${BOTAPI_DOWNLOADS_MOUNT:-./downloads}:${BOTAPI_DOWNLOADS_CONTAINER_PATH:-/data/downloads}
    command:
      - "--http-port=8081"
      - "--dir=/var/lib/telegram-bot-api"
      - "--api-id=${TELEGRAM_API_ID}"
      - "--api-hash=${TELEGRAM_API_HASH}"
      - "--local"
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/127.0.0.1/8081'"]
      interval: 5s
      timeout: 2s
      retries: 20
      start_period: 10s

  bot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    restart: unless-stopped
    depends_on:
      telegram-bot-api:
        condition: service_healthy
    env_file:
      - ./.env
    environment:
      # Override host URLs with docker network name
      BOT_API_BASE_URL: "http://telegram-bot-api:8081/bot"
      BOT_API_FILE_URL: "http://telegram-bot-api:8081/file/bot"
      # Inside container downloads are here
      DOWNLOAD_ROOT: "/data/downloads"
      BOT_LOCAL_MODE: "true"
      # Timeouts for large uploads handled by local Bot API server
      BOT_HTTP_READ_TIMEOUT_SEC: "600"
      BOT_HTTP_WRITE_TIMEOUT_SEC: "600"
    volumes:
      - ./downloads:/data/downloads

